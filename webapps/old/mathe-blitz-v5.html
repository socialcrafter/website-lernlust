<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathe-Blitz Training</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --success: #95E1A3;
            --bg-light: #FFF9F0;
            --bg-card: #FFFFFF;
            --text-dark: #2D3436;
            --text-muted: #636E72;
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
            --shadow-hover: 0 12px 48px rgba(0,0,0,0.15);
            
            --star-color: #FFD700;
            --diamond-color: #00CED1;
            --obsidian-color: #4A0E4E;
            
            --dot-filled: #3b82f6;
            --dot-second: #FF6B6B;
            --dot-complement: #8b5cf6;
            --dot-empty: #e9ecef;
            --frame-border: #dfe6e9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-shapes {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 20s infinite ease-in-out;
        }

        .shape-1 {
            width: 300px; height: 300px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            top: -100px; right: -100px;
        }

        .shape-2 {
            width: 200px; height: 200px;
            background: linear-gradient(135deg, var(--secondary), #81ECEC);
            bottom: 10%; left: -50px;
            animation-delay: -5s;
        }

        .shape-3 {
            width: 150px; height: 150px;
            background: linear-gradient(135deg, var(--accent), #FFEAA7);
            top: 40%; right: 5%;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(20px, -20px) rotate(5deg); }
            50% { transform: translate(-10px, 20px) rotate(-5deg); }
            75% { transform: translate(-20px, -10px) rotate(3deg); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-family: 'Fredoka', sans-serif;
            font-size: clamp(2rem, 6vw, 2.5rem);
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .header h1 span {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p { color: var(--text-muted); font-size: 0.95rem; }

        .rewards-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            color: var(--text-dark);
            background: var(--bg-card);
            padding: 10px 18px;
            border-radius: 50px;
            box-shadow: var(--shadow);
        }

        .reward-icon {
            width: 24px; height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reward-icon.star { color: var(--star-color); }
        .reward-icon.diamond { color: var(--diamond-color); }
        .reward-icon.obsidian { color: var(--obsidian-color); }
        .reward-icon svg { width: 100%; height: 100%; }

        @keyframes twinkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.85; }
        }

        .reward-icon.animate { animation: twinkle 0.6s ease; }

        .card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.3rem;
            color: var(--text-dark);
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-grid { display: grid; gap: 12px; }
        .mode-section { margin-bottom: 25px; }
        .mode-section:last-child { margin-bottom: 0; }

        .mode-section-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-align: center;
        }

        .mode-btn {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .mode-btn .mode-name { font-weight: 600; }
        .mode-btn .mode-desc { font-size: 0.85rem; opacity: 0.9; }

        .mode-btn.mengen { background: linear-gradient(135deg, #10b981, #059669); }
        .mode-btn.verliebt { background: linear-gradient(135deg, #ec4899, #be185d); }
        .mode-btn.zehnertrick { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .mode-btn.zehnerstopp-plus { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .mode-btn.zehnerstopp-minus { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .mode-btn.plus { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .mode-btn.mult { background: linear-gradient(135deg, #ec4899, #db2777); }

        .training-card { display: none; }
        .training-card.active { display: block; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-container { margin-bottom: 25px; }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--success));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .instruction {
            text-align: center;
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .instruction strong { color: var(--text-dark); }

        .btn {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            padding: 14px 32px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover { transform: translateY(-2px); }

        .btn-reveal {
            background: linear-gradient(135deg, var(--accent), #f9ca24);
            color: var(--text-dark);
            width: 100%;
            font-size: 1rem;
        }

        .btn-correct {
            background: linear-gradient(135deg, var(--success), #7BED9F);
            color: white;
            flex: 1;
        }

        .btn-wrong {
            background: linear-gradient(135deg, var(--primary), #ee5a5a);
            color: white;
            flex: 1;
        }

        .btn-back {
            background: transparent;
            color: var(--text-muted);
            font-size: 0.9rem;
            padding: 10px;
        }

        .btn-back:hover { color: var(--text-dark); }

        .btn-fallback {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: var(--text-dark);
            font-size: 0.95rem;
            margin-top: 15px;
            border: 2px solid #f59e0b;
        }

        .button-row {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .hidden { display: none !important; }

        /* Ten Frame */
        .ten-frame {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            padding: 16px;
            background: #f8f9fa;
            border: 3px solid var(--frame-border);
            border-radius: 16px;
        }

        .ten-frame-cell {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--dot-empty);
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }

        .ten-frame-cell.filled-blue {
            background: linear-gradient(135deg, var(--dot-filled), #2563eb);
            border-color: var(--dot-filled);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .ten-frame-cell.filled-red {
            background: linear-gradient(135deg, var(--dot-second), #dc2626);
            border-color: var(--dot-second);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .ten-frame-cell.filled-purple {
            background: linear-gradient(135deg, var(--dot-complement), #7c3aed);
            border-color: var(--dot-complement);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .ten-frame-cell.removing {
            animation: shrinkOut 0.4s ease forwards;
        }

        @keyframes shrinkOut {
            to { transform: scale(0); opacity: 0; }
        }

        /* Zehner-Stopp Styles */
        .zehnerstopp-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .zehnerstopp-task {
            font-family: 'Fredoka', sans-serif;
            font-size: 2.5rem;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 10px;
        }

        .zehnerstopp-task .num-first { color: var(--dot-filled); }
        .zehnerstopp-task .num-second { color: var(--dot-second); }
        .zehnerstopp-task .operator { color: var(--text-muted); }

        .zehnerstopp-visual {
            display: flex;
            align-items: flex-start;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .frame-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .frame-label {
            font-family: 'Fredoka', sans-serif;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .vorrat-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 120px;
            justify-content: center;
            padding: 16px;
            background: #fff5f5;
            border: 3px dashed var(--dot-second);
            border-radius: 16px;
            min-height: 80px;
        }

        .vorrat-dot {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--dot-second), #dc2626);
            border: 2px solid var(--dot-second);
            transition: all 0.4s ease;
        }

        .vorrat-dot.used {
            opacity: 0;
            transform: scale(0);
        }

        .step-question {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            color: var(--text-dark);
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border-radius: 12px;
        }

        .answer-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 300px;
        }

        .answer-btn {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.3rem;
            width: 55px; height: 55px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .answer-btn:hover:not(:disabled) {
            border-color: var(--secondary);
            transform: scale(1.05);
        }

        .answer-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .answer-btn.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .answer-btn.wrong {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .zehnerstopp-result {
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            color: var(--text-dark);
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            padding: 15px 25px;
            border-radius: 16px;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .zehnerstopp-result.visible { opacity: 1; }

        .result-10 {
            background: var(--dot-filled);
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
        }

        .result-rest {
            background: var(--dot-second);
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
        }

        .result-equals {
            font-size: 2rem;
            color: var(--success);
        }

        .einzelne-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 16px;
            background: #f0fdf4;
            border: 3px solid var(--success);
            border-radius: 16px;
            min-height: 60px;
        }

        .einzelne-dot {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success), #7BED9F);
            border: 2px solid var(--success);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .einzelne-dot:hover { transform: scale(1.1); }

        .einzelne-dot.selected {
            background: linear-gradient(135deg, #fca5a5, #f87171);
            border-color: var(--primary);
        }

        .einzelne-dot.removed {
            animation: shrinkOut 0.4s ease forwards;
        }

        /* Completion & Reward */
        .completion-card {
            text-align: center;
            padding: 40px 30px;
        }

        .completion-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.8rem;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .completion-stats {
            color: var(--text-muted);
            margin-bottom: 25px;
        }

        .completion-message {
            background: linear-gradient(135deg, #fff9e6, #fff3cd);
            padding: 15px 20px;
            border-radius: 12px;
            color: var(--text-dark);
            font-size: 0.95rem;
            margin-bottom: 25px;
        }

        .btn-restart {
            background: linear-gradient(135deg, var(--secondary), #45b7aa);
            color: white;
        }

        .reward-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .reward-overlay.show { display: flex; }

        .reward-popup {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 320px;
        }

        .reward-popup-icon {
            width: 80px; height: 80px;
            margin: 0 auto 20px;
        }

        .reward-popup-icon svg { width: 100%; height: 100%; }

        .reward-popup-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.6rem;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .reward-popup-text {
            color: var(--text-muted);
            margin-bottom: 25px;
        }

        .btn-continue {
            background: linear-gradient(135deg, var(--secondary), #45b7aa);
            color: white;
        }

        @media (max-width: 400px) {
            .container { padding: 12px; }
            .card { padding: 20px; }
            .ten-frame-cell { width: 34px; height: 34px; }
            .ten-frame { gap: 6px; padding: 12px; }
            .vorrat-dot, .einzelne-dot { width: 30px; height: 30px; }
            .answer-btn { width: 48px; height: 48px; font-size: 1.1rem; }
            .zehnerstopp-task { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="bg-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <div class="container">
        <header class="header">
            <h1><span>Mathe-Blitz</span></h1>
            <p>Training nach Born/Oehler</p>
            
            <div class="rewards-display">
                <div class="reward-item">
                    <div class="reward-icon star" id="starIcon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <span id="starCount">0</span>
                </div>
                <div class="reward-item">
                    <div class="reward-icon diamond" id="diamondIcon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L2 12l10 10 10-10L12 2z"/>
                        </svg>
                    </div>
                    <span id="diamondCount">0</span>
                </div>
                <div class="reward-item">
                    <div class="reward-icon obsidian" id="obsidianIcon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L2 12l10 10 10-10L12 2zm0 3l7 7-7 7-7-7 7-7z"/>
                        </svg>
                    </div>
                    <span id="obsidianCount">0</span>
                </div>
            </div>
        </header>

        <!-- Start Screen -->
        <div class="card" id="startScreen">
            <h3 class="card-title">Wähle dein Training</h3>
            
            <div class="mode-section">
                <div class="mode-section-title">Grundlagen</div>
                <div class="mode-grid">
                    <button class="mode-btn mengen" onclick="startMengenTraining()">
                        <span class="mode-name">Mengen-Bilder</span>
                        <span class="mode-desc">Zahlen 1-10 sehen</span>
                    </button>
                </div>
            </div>

            <div class="mode-section">
                <div class="mode-section-title">Aufbau & Strategie</div>
                <div class="mode-grid">
                    <button class="mode-btn verliebt" onclick="startVerliebteTraining()">
                        <span class="mode-name">Verliebte Zahlen</span>
                        <span class="mode-desc">Ergänzen auf 10</span>
                    </button>
                    <button class="mode-btn zehnertrick" onclick="startZehnertrickTraining()">
                        <span class="mode-name">Zehner-Trick</span>
                        <span class="mode-desc">Analogien nutzen</span>
                    </button>
                </div>
            </div>

            <div class="mode-section">
                <div class="mode-section-title">Der Zehner-Stopp</div>
                <div class="mode-grid">
                    <button class="mode-btn zehnerstopp-plus" onclick="startZehnerstoppPlus()">
                        <span class="mode-name">Die 10 voll machen</span>
                        <span class="mode-desc">Plus über die 10</span>
                    </button>
                    <button class="mode-btn zehnerstopp-minus" onclick="startZehnerstoppMinus()">
                        <span class="mode-name">Rückwärts zur 10</span>
                        <span class="mode-desc">Minus über die 10</span>
                    </button>
                </div>
            </div>
            
            <div class="mode-section">
                <div class="mode-section-title">Karteikarten</div>
                <div class="mode-grid">
                    <button class="mode-btn plus" onclick="startCardTraining('plus10')">
                        <span class="mode-name">Addition bis 10</span>
                        <span class="mode-desc">Automatisieren</span>
                    </button>
                    <button class="mode-btn mult" onclick="startCardTraining('mult')">
                        <span class="mode-name">Kleines 1x1</span>
                        <span class="mode-desc">Automatisieren</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mengen Training -->
        <div class="card training-card" id="mengenTrainingScreen">
            <div class="progress-container">
                <div class="progress-text" id="mengenProgressText">Bild 1 von 10</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="mengenProgressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="instruction">Wie viele sind es? (Nicht zählen)</div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px;">
                <div class="ten-frame" id="mengenTenFrame"></div>
                <div class="answer-buttons" id="mengenButtons"></div>
            </div>
            <button class="btn btn-back" onclick="backToStart()">Zurück</button>
        </div>

        <!-- Verliebte Zahlen -->
        <div class="card training-card" id="verliebtTrainingScreen">
            <div class="progress-container">
                <div class="progress-text" id="verliebtProgressText">Aufgabe 1 von 9</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="verliebtProgressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="instruction">Fülle auf 10!</div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px;">
                <div class="ten-frame" id="verliebtTenFrame"></div>
                <div class="step-question" id="verliebtQuestion">? + ? = 10</div>
                <div class="answer-buttons" id="verliebtButtons"></div>
            </div>
            <button class="btn btn-back" onclick="backToStart()">Zurück</button>
        </div>

        <!-- Zehner-Trick -->
        <div class="card training-card" id="zehnertrickTrainingScreen">
            <div class="progress-container">
                <div class="progress-text" id="zehnertrickProgressText">Aufgabe 1 von 6</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="zehnertrickProgressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="instruction" id="zehnertrickInstruction">Löse zuerst die kleine Aufgabe!</div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px;">
                <div class="step-question" id="zehnertrickSmall">3 + 4 = ?</div>
                <div class="step-question" id="zehnertrickBig" style="opacity: 0.4;">53 + 4 = ?</div>
                <div class="answer-buttons" id="zehnertrickButtons"></div>
            </div>
            <button class="btn btn-back" onclick="backToStart()">Zurück</button>
        </div>

        <!-- Zehner-Stopp Plus -->
        <div class="card training-card" id="zehnerstoppPlusScreen">
            <div class="progress-container">
                <div class="progress-text" id="zsPlusProgressText">Aufgabe 1 von 6</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="zsPlusProgressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="zehnerstopp-task" id="zsPlusTask">
                <span class="num-first">8</span>
                <span class="operator"> + </span>
                <span class="num-second">5</span>
            </div>
            
            <div class="zehnerstopp-visual">
                <div class="frame-section">
                    <div class="frame-label">10er-Feld</div>
                    <div class="ten-frame" id="zsPlusTenFrame"></div>
                </div>
                <div class="frame-section">
                    <div class="frame-label">Vorrat</div>
                    <div class="vorrat-container" id="zsPlusVorrat"></div>
                </div>
            </div>
            
            <div class="step-question" id="zsPlusQuestion">Wie viele fehlen bis zur 10?</div>
            <div class="answer-buttons" id="zsPlusButtons"></div>
            
            <div class="zehnerstopp-result" id="zsPlusResult">
                <span class="result-10">10</span>
                <span>+</span>
                <span class="result-rest" id="zsPlusRest">3</span>
                <span class="result-equals">=</span>
                <span class="result-equals" id="zsPlusFinal">13</span>
            </div>
            
            <button class="btn btn-fallback hidden" id="zsPlusFallback" onclick="startVerliebteTraining()">
                Lass uns kurz "Verliebte Zahlen" auffrischen!
            </button>
            
            <button class="btn btn-back" onclick="backToStart()">Zurück</button>
        </div>

        <!-- Zehner-Stopp Minus -->
        <div class="card training-card" id="zehnerstoppMinusScreen">
            <div class="progress-container">
                <div class="progress-text" id="zsMinusProgressText">Aufgabe 1 von 6</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="zsMinusProgressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="zehnerstopp-task" id="zsMinusTask">
                <span class="num-first">15</span>
                <span class="operator"> - </span>
                <span class="num-second">7</span>
            </div>
            
            <div class="zehnerstopp-visual">
                <div class="frame-section">
                    <div class="frame-label">10er-Stange</div>
                    <div class="ten-frame" id="zsMinusTenFrame"></div>
                </div>
                <div class="frame-section">
                    <div class="frame-label">Einzelne</div>
                    <div class="einzelne-container" id="zsMinusEinzelne"></div>
                </div>
            </div>
            
            <div class="step-question" id="zsMinusQuestion">Weg zur 10! Klicke auf die Einzelnen.</div>
            <div class="answer-buttons" id="zsMinusButtons"></div>
            
            <div class="zehnerstopp-result" id="zsMinusResult">
                <span class="result-equals" id="zsMinusFinal">8</span>
            </div>
            
            <button class="btn btn-fallback hidden" id="zsMinusFallback" onclick="startVerliebteTraining()">
                Lass uns kurz "Verliebte Zahlen" auffrischen!
            </button>
            
            <button class="btn btn-back" onclick="backToStart()">Zurück</button>
        </div>

        <!-- Card Training -->
        <div class="card training-card" id="cardTrainingScreen">
            <div class="progress-container">
                <div class="progress-text" id="cardProgressText">Karte 1 von 6</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="cardProgressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="instruction">Nicht rechnen. Einprägen.</div>
            <div style="background: white; border: 3px solid #e9ecef; border-radius: 20px; min-height: 140px; display: flex; align-items: center; justify-content: center; margin-bottom: 25px;" id="flashcard">
                <div style="font-family: 'Fredoka', sans-serif; font-size: 3rem; color: var(--text-dark);" id="flashcardContent">3 + 4</div>
            </div>
            <div id="preRevealControls">
                <button class="btn btn-reveal" onclick="revealCardAnswer()">Lösung zeigen</button>
            </div>
            <div id="postRevealControls" class="hidden">
                <div class="button-row">
                    <button class="btn btn-correct" onclick="rateCard(true)">Gewusst</button>
                    <button class="btn btn-wrong" onclick="rateCard(false)">Nicht gewusst</button>
                </div>
            </div>
            <button class="btn btn-back" onclick="backToStart()">Zurück</button>
        </div>

        <!-- Completion -->
        <div class="card training-card" id="completionScreen">
            <div class="completion-card">
                <h2 class="completion-title" id="completionTitle">Geschafft</h2>
                <div class="completion-stats" id="completionStats"></div>
                <div class="completion-message" id="completionMessage"></div>
                <button class="btn btn-restart" onclick="backToStart()">Weiter trainieren</button>
            </div>
        </div>
    </div>

    <!-- Reward Overlay -->
    <div class="reward-overlay" id="rewardOverlay">
        <div class="reward-popup">
            <div class="reward-popup-icon" id="rewardPopupIcon"></div>
            <h2 class="reward-popup-title" id="rewardPopupTitle">Neuer Diamant</h2>
            <p class="reward-popup-text" id="rewardPopupText"></p>
            <button class="btn btn-continue" onclick="closeRewardPopup()">Weiter</button>
        </div>
    </div>

    <script>
        const problemSets = {
            plus10: {
                problems: [
                    { q: '4 + 3', a: 7 }, { q: '2 + 6', a: 8 }, { q: '5 + 4', a: 9 },
                    { q: '7 + 2', a: 9 }, { q: '3 + 3', a: 6 }, { q: '6 + 2', a: 8 },
                ]
            },
            mult: {
                problems: [
                    { q: '3 x 4', a: 12 }, { q: '7 x 8', a: 56 }, { q: '6 x 6', a: 36 },
                    { q: '9 x 3', a: 27 }, { q: '4 x 8', a: 32 }, { q: '5 x 7', a: 35 },
                ]
            }
        };

        let state = {
            stars: 0, diamonds: 0, obsidian: 0,
            gameType: null, currentIndex: 0, correctCount: 0, totalCount: 0,
            cards: [], mengenNumbers: [], verliebtNumbers: [],
            zehnertrickTasks: [], zehnertrickPhase: 1,
            zsPlusTasks: [], zsPlusSubStep: 1, zsPlusFirst: 0, zsPlusSecond: 0,
            zsPlusToTen: 0, zsPlusRest: 0, zsPlusErrors: 0,
            zsMinusTasks: [], zsMinusSubStep: 1, zsMinusFirst: 0, zsMinusSecond: 0,
            zsMinusEinzelne: 0, zsMinusStillToRemove: 0, zsMinusErrors: 0
        };

        function loadState() {
            const saved = localStorage.getItem('matheBlitzState');
            if (saved) {
                const p = JSON.parse(saved);
                state.stars = p.stars || 0;
                state.diamonds = p.diamonds || 0;
                state.obsidian = p.obsidian || 0;
            }
            updateRewardsDisplay();
        }

        function saveState() {
            localStorage.setItem('matheBlitzState', JSON.stringify({
                stars: state.stars, diamonds: state.diamonds, obsidian: state.obsidian
            }));
        }

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function updateRewardsDisplay() {
            document.getElementById('starCount').textContent = state.stars % 1000;
            document.getElementById('diamondCount').textContent = state.diamonds % 1000;
            document.getElementById('obsidianCount').textContent = state.obsidian;
        }

        function addStar() {
            state.stars++;
            if (state.stars >= 1000) {
                state.stars -= 1000;
                state.diamonds++;
                if (state.diamonds >= 1000) {
                    state.diamonds -= 1000;
                    state.obsidian++;
                    showRewardPopup('obsidian');
                } else {
                    showRewardPopup('diamond');
                }
            }
            updateRewardsDisplay();
            saveState();
            const icon = document.getElementById('starIcon');
            icon.classList.remove('animate');
            void icon.offsetWidth;
            icon.classList.add('animate');
        }

        function showRewardPopup(type) {
            const icon = document.getElementById('rewardPopupIcon');
            const title = document.getElementById('rewardPopupTitle');
            const text = document.getElementById('rewardPopupText');
            if (type === 'diamond') {
                icon.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 12l10 10 10-10L12 2z"/></svg>';
                icon.style.color = 'var(--diamond-color)';
                title.textContent = 'Neuer Diamant';
                text.textContent = '1000 Sterne = 1 Diamant';
            } else {
                icon.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 12l10 10 10-10L12 2zm0 3l7 7-7 7-7-7 7-7z"/></svg>';
                icon.style.color = 'var(--obsidian-color)';
                title.textContent = 'Neuer Obsidian';
                text.textContent = '1000 Diamanten = 1 Obsidian';
            }
            document.getElementById('rewardOverlay').classList.add('show');
        }

        function closeRewardPopup() {
            document.getElementById('rewardOverlay').classList.remove('show');
        }

        function showScreen(id) {
            document.querySelectorAll('.training-card').forEach(el => el.classList.remove('active'));
            document.getElementById('startScreen').classList.add('hidden');
            if (id === 'start') {
                document.getElementById('startScreen').classList.remove('hidden');
            } else {
                document.getElementById(id).classList.add('active');
            }
        }

        function backToStart() { showScreen('start'); }

        function showCompletion() {
            const pct = state.totalCount > 0 ? Math.round((state.correctCount / state.totalCount) * 100) : 0;
            let title = 'Geschafft', msg = '';
            
            switch(state.gameType) {
                case 'mengen': title = 'Mengen-Training fertig'; msg = pct >= 80 ? 'Du siehst Zahlen auf einen Blick.' : 'Weiter üben!'; break;
                case 'verliebt': title = 'Verliebte Zahlen gemeistert'; msg = pct >= 80 ? 'Die 10er-Partner sitzen!' : 'Nochmal üben!'; break;
                case 'zehnertrick': title = 'Zehner-Trick geschafft'; msg = pct >= 80 ? 'Du nutzt Analogien perfekt.' : 'Weiter üben!'; break;
                case 'zsPlusTraining': title = 'Plus über die 10 geschafft'; msg = pct >= 80 ? 'Du machst die 10 voll!' : 'Weiter üben!'; break;
                case 'zsMinusTraining': title = 'Minus über die 10 geschafft'; msg = pct >= 80 ? 'Du rechnest rückwärts zur 10!' : 'Weiter üben!'; break;
                default: title = 'Runde fertig'; msg = pct >= 80 ? 'Gut gemacht!' : 'Weiter üben!';
            }
            
            document.getElementById('completionTitle').textContent = title;
            document.getElementById('completionStats').textContent = `${state.correctCount} von ${state.totalCount} richtig (${pct}%)`;
            document.getElementById('completionMessage').textContent = msg;
            showScreen('completionScreen');
        }

        function createAnswerButtons(container, options, correctAnswer, onCorrect, onWrong) {
            container.innerHTML = '';
            shuffle(options).forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = num;
                btn.onclick = () => {
                    container.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
                    if (num === correctAnswer) {
                        btn.classList.add('correct');
                        setTimeout(onCorrect, 400);
                    } else {
                        btn.classList.add('wrong');
                        setTimeout(() => {
                            btn.classList.remove('wrong');
                            container.querySelectorAll('.answer-btn').forEach(b => b.disabled = false);
                            if (onWrong) onWrong();
                        }, 500);
                    }
                };
                container.appendChild(btn);
            });
        }

        function initTenFrame(id) {
            const tf = document.getElementById(id);
            tf.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const cell = document.createElement('div');
                cell.className = 'ten-frame-cell';
                tf.appendChild(cell);
            }
        }

        function fillTenFrame(id, count, colorClass = 'filled-blue') {
            const cells = document.querySelectorAll(`#${id} .ten-frame-cell`);
            cells.forEach((cell, i) => {
                cell.className = 'ten-frame-cell';
                if (i < count) cell.classList.add(colorClass);
            });
        }

        function updateProgress(prefix, current, total) {
            document.getElementById(`${prefix}ProgressFill`).style.width = (current / total * 100) + '%';
            document.getElementById(`${prefix}ProgressText`).textContent = `Aufgabe ${current + 1} von ${total}`;
        }

        // Mengen
        function startMengenTraining() {
            state.gameType = 'mengen';
            state.mengenNumbers = shuffle([1,2,3,4,5,6,7,8,9,10]);
            state.currentIndex = 0; state.correctCount = 0; state.totalCount = 0;
            initTenFrame('mengenTenFrame');
            showScreen('mengenTrainingScreen');
            showMengenTask();
        }

        function showMengenTask() {
            const num = state.mengenNumbers[state.currentIndex];
            fillTenFrame('mengenTenFrame', num, 'filled-blue');
            const options = [num];
            while (options.length < 6) {
                const opt = num + Math.floor(Math.random() * 5) - 2;
                if (opt >= 1 && opt <= 10 && !options.includes(opt)) options.push(opt);
            }
            createAnswerButtons(document.getElementById('mengenButtons'), options, num,
                () => { state.correctCount++; state.totalCount++; addStar(); nextMengen(); },
                () => { state.totalCount++; }
            );
            updateProgress('mengen', state.currentIndex, state.mengenNumbers.length);
        }

        function nextMengen() {
            state.currentIndex++;
            if (state.currentIndex < state.mengenNumbers.length) showMengenTask();
            else showCompletion();
        }

        // Verliebte Zahlen
        function startVerliebteTraining() {
            state.gameType = 'verliebt';
            state.verliebtNumbers = shuffle([1,2,3,4,5,6,7,8,9]);
            state.currentIndex = 0; state.correctCount = 0; state.totalCount = 0;
            initTenFrame('verliebtTenFrame');
            showScreen('verliebtTrainingScreen');
            showVerliebtTask();
        }

        function showVerliebtTask() {
            const given = state.verliebtNumbers[state.currentIndex];
            const complement = 10 - given;
            fillTenFrame('verliebtTenFrame', given, 'filled-blue');
            document.getElementById('verliebtQuestion').innerHTML = `<span style="color:var(--dot-filled)">${given}</span> + ? = 10`;
            const options = [complement];
            while (options.length < 6) {
                const opt = complement + Math.floor(Math.random() * 5) - 2;
                if (opt >= 1 && opt <= 9 && !options.includes(opt)) options.push(opt);
            }
            createAnswerButtons(document.getElementById('verliebtButtons'), options, complement,
                () => {
                    const cells = document.querySelectorAll('#verliebtTenFrame .ten-frame-cell');
                    for (let i = given; i < 10; i++) setTimeout(() => cells[i].classList.add('filled-purple'), (i-given)*100);
                    state.correctCount++; state.totalCount++; addStar();
                    setTimeout(nextVerliebt, 800);
                },
                () => { state.totalCount++; }
            );
            updateProgress('verliebt', state.currentIndex, state.verliebtNumbers.length);
        }

        function nextVerliebt() {
            state.currentIndex++;
            if (state.currentIndex < state.verliebtNumbers.length) showVerliebtTask();
            else showCompletion();
        }

        // Zehner-Trick
        function startZehnertrickTraining() {
            state.gameType = 'zehnertrick';
            state.zehnertrickTasks = shuffle([
                {a:3,b:4,decade:20},{a:2,b:5,decade:40},{a:4,b:3,decade:50},
                {a:5,b:4,decade:30},{a:2,b:6,decade:60},{a:3,b:5,decade:70}
            ]);
            state.currentIndex = 0; state.zehnertrickPhase = 1;
            state.correctCount = 0; state.totalCount = 0;
            showScreen('zehnertrickTrainingScreen');
            showZehnertrickTask();
        }

        function showZehnertrickTask() {
            const task = state.zehnertrickTasks[state.currentIndex];
            const smallResult = task.a + task.b;
            const bigResult = task.decade + task.a + task.b;
            state.zehnertrickPhase = 1;
            document.getElementById('zehnertrickSmall').innerHTML = `<span style="color:var(--einer-color)">${task.a}</span> + <span style="color:var(--einer-color)">${task.b}</span> = ?`;
            document.getElementById('zehnertrickSmall').style.opacity = '1';
            document.getElementById('zehnertrickBig').innerHTML = `${task.decade/10}<span style="color:var(--einer-color)">${task.a}</span> + <span style="color:var(--einer-color)">${task.b}</span> = ?`;
            document.getElementById('zehnertrickBig').style.opacity = '0.4';
            document.getElementById('zehnertrickInstruction').textContent = 'Kleine Aufgabe zuerst!';
            const options = [smallResult];
            while (options.length < 6) {
                const opt = smallResult + Math.floor(Math.random()*5)-2;
                if (opt > 0 && opt < 20 && !options.includes(opt)) options.push(opt);
            }
            createAnswerButtons(document.getElementById('zehnertrickButtons'), options, smallResult,
                () => {
                    document.getElementById('zehnertrickSmall').innerHTML = `<span style="color:var(--einer-color)">${task.a}</span> + <span style="color:var(--einer-color)">${task.b}</span> = <strong>${smallResult}</strong>`;
                    document.getElementById('zehnertrickBig').style.opacity = '1';
                    document.getElementById('zehnertrickInstruction').textContent = 'Jetzt die große Aufgabe!';
                    state.zehnertrickPhase = 2;
                    const bigOptions = [bigResult];
                    while (bigOptions.length < 6) {
                        const opt = bigResult + Math.floor(Math.random()*7)-3;
                        if (opt > 10 && opt < 100 && !bigOptions.includes(opt)) bigOptions.push(opt);
                    }
                    createAnswerButtons(document.getElementById('zehnertrickButtons'), bigOptions, bigResult,
                        () => {
                            document.getElementById('zehnertrickBig').innerHTML = `${task.decade/10}<span style="color:var(--einer-color)">${task.a}</span> + <span style="color:var(--einer-color)">${task.b}</span> = <strong style="color:var(--success)">${bigResult}</strong>`;
                            state.correctCount++; state.totalCount++; addStar();
                            setTimeout(nextZehnertrick, 600);
                        },
                        () => { state.totalCount++; }
                    );
                }, null
            );
            updateProgress('zehnertrick', state.currentIndex, state.zehnertrickTasks.length);
        }

        function nextZehnertrick() {
            state.currentIndex++;
            if (state.currentIndex < state.zehnertrickTasks.length) showZehnertrickTask();
            else showCompletion();
        }

        // Zehner-Stopp Plus
        function startZehnerstoppPlus() {
            state.gameType = 'zsPlusTraining';
            state.zsPlusTasks = shuffle([
                {first:8,second:5},{first:7,second:6},{first:9,second:4},
                {first:6,second:7},{first:8,second:4},{first:7,second:5}
            ]);
            state.currentIndex = 0; state.correctCount = 0; state.totalCount = 0; state.zsPlusErrors = 0;
            initTenFrame('zsPlusTenFrame');
            showScreen('zehnerstoppPlusScreen');
            showZsPlusTask();
        }

        function showZsPlusTask() {
            const task = state.zsPlusTasks[state.currentIndex];
            state.zsPlusFirst = task.first; state.zsPlusSecond = task.second;
            state.zsPlusToTen = 10 - task.first; state.zsPlusRest = task.second - state.zsPlusToTen;
            state.zsPlusSubStep = 1; state.zsPlusErrors = 0;
            document.getElementById('zsPlusTask').innerHTML = `<span class="num-first">${task.first}</span><span class="operator"> + </span><span class="num-second">${task.second}</span>`;
            fillTenFrame('zsPlusTenFrame', task.first, 'filled-blue');
            const vorrat = document.getElementById('zsPlusVorrat');
            vorrat.innerHTML = '';
            for (let i = 0; i < task.second; i++) {
                const dot = document.createElement('div');
                dot.className = 'vorrat-dot';
                vorrat.appendChild(dot);
            }
            document.getElementById('zsPlusResult').classList.remove('visible');
            document.getElementById('zsPlusFallback').classList.add('hidden');
            showZsPlusStep1();
            updateProgress('zsPlus', state.currentIndex, state.zsPlusTasks.length);
        }

        function showZsPlusStep1() {
            document.getElementById('zsPlusQuestion').textContent = 'Wie viele fehlen bis zur 10?';
            const options = [state.zsPlusToTen];
            while (options.length < 5) {
                const opt = state.zsPlusToTen + Math.floor(Math.random()*5)-2;
                if (opt >= 1 && opt <= 9 && !options.includes(opt)) options.push(opt);
            }
            createAnswerButtons(document.getElementById('zsPlusButtons'), options, state.zsPlusToTen,
                () => {
                    const vorratDots = document.querySelectorAll('#zsPlusVorrat .vorrat-dot');
                    const cells = document.querySelectorAll('#zsPlusTenFrame .ten-frame-cell');
                    for (let i = 0; i < state.zsPlusToTen; i++) {
                        setTimeout(() => {
                            if (vorratDots[i]) vorratDots[i].classList.add('used');
                            cells[state.zsPlusFirst + i].classList.add('filled-red');
                        }, i * 150);
                    }
                    setTimeout(showZsPlusStep2, state.zsPlusToTen * 150 + 400);
                },
                () => {
                    state.zsPlusErrors++;
                    if (state.zsPlusErrors >= 2) document.getElementById('zsPlusFallback').classList.remove('hidden');
                }
            );
        }

        function showZsPlusStep2() {
            state.zsPlusSubStep = 2;
            document.getElementById('zsPlusQuestion').textContent = 'Wie viele rote sind noch übrig?';
            const options = [state.zsPlusRest];
            while (options.length < 5) {
                const opt = state.zsPlusRest + Math.floor(Math.random()*5)-2;
                if (opt >= 0 && opt <= 9 && !options.includes(opt)) options.push(opt);
            }
            createAnswerButtons(document.getElementById('zsPlusButtons'), options, state.zsPlusRest,
                () => {
                    const final = 10 + state.zsPlusRest;
                    document.getElementById('zsPlusRest').textContent = state.zsPlusRest;
                    document.getElementById('zsPlusFinal').textContent = final;
                    document.getElementById('zsPlusResult').classList.add('visible');
                    document.getElementById('zsPlusQuestion').textContent = `10 + ${state.zsPlusRest} = ${final}`;
                    document.getElementById('zsPlusButtons').innerHTML = '';
                    state.correctCount++; state.totalCount++; addStar();
                    setTimeout(nextZsPlusTask, 1500);
                },
                () => { state.zsPlusErrors++; }
            );
        }

        function nextZsPlusTask() {
            state.currentIndex++;
            if (state.currentIndex < state.zsPlusTasks.length) showZsPlusTask();
            else showCompletion();
        }

        // Zehner-Stopp Minus
        let selectedEinzelne = 0;

        function startZehnerstoppMinus() {
            state.gameType = 'zsMinusTraining';
            state.zsMinusTasks = shuffle([
                {first:15,second:7},{first:13,second:5},{first:14,second:6},
                {first:12,second:4},{first:16,second:8},{first:11,second:3}
            ]);
            state.currentIndex = 0; state.correctCount = 0; state.totalCount = 0; state.zsMinusErrors = 0;
            initTenFrame('zsMinusTenFrame');
            showScreen('zehnerstoppMinusScreen');
            showZsMinusTask();
        }

        function showZsMinusTask() {
            const task = state.zsMinusTasks[state.currentIndex];
            state.zsMinusFirst = task.first; state.zsMinusSecond = task.second;
            state.zsMinusEinzelne = task.first - 10;
            state.zsMinusStillToRemove = task.second - state.zsMinusEinzelne;
            state.zsMinusSubStep = 1; state.zsMinusErrors = 0; selectedEinzelne = 0;
            document.getElementById('zsMinusTask').innerHTML = `<span class="num-first">${task.first}</span><span class="operator"> - </span><span class="num-second">${task.second}</span>`;
            fillTenFrame('zsMinusTenFrame', 10, 'filled-blue');
            const einzelne = document.getElementById('zsMinusEinzelne');
            einzelne.innerHTML = '';
            for (let i = 0; i < state.zsMinusEinzelne; i++) {
                const dot = document.createElement('div');
                dot.className = 'einzelne-dot';
                dot.onclick = () => selectEinzelneDot(dot);
                einzelne.appendChild(dot);
            }
            document.getElementById('zsMinusResult').classList.remove('visible');
            document.getElementById('zsMinusFallback').classList.add('hidden');
            document.getElementById('zsMinusButtons').innerHTML = '';
            document.getElementById('zsMinusQuestion').innerHTML = `Weg zur 10! Klicke auf alle <strong>${state.zsMinusEinzelne}</strong> Einzelnen.`;
            updateProgress('zsMinus', state.currentIndex, state.zsMinusTasks.length);
        }

        function selectEinzelneDot(dot) {
            if (dot.classList.contains('selected')) return;
            dot.classList.add('selected');
            selectedEinzelne++;
            if (selectedEinzelne === state.zsMinusEinzelne) {
                setTimeout(() => {
                    document.querySelectorAll('#zsMinusEinzelne .einzelne-dot').forEach(d => d.classList.add('removed'));
                    setTimeout(showZsMinusStep2, 500);
                }, 300);
            }
        }

        function showZsMinusStep2() {
            state.zsMinusSubStep = 2;
            document.getElementById('zsMinusQuestion').innerHTML = `${state.zsMinusEinzelne} weg! Wir wollten ${state.zsMinusSecond} wegnehmen.<br>Wie viele fehlen noch?`;
            const options = [state.zsMinusStillToRemove];
            while (options.length < 5) {
                const opt = state.zsMinusStillToRemove + Math.floor(Math.random()*5)-2;
                if (opt >= 1 && opt <= 9 && !options.includes(opt)) options.push(opt);
            }
            createAnswerButtons(document.getElementById('zsMinusButtons'), options, state.zsMinusStillToRemove,
                showZsMinusStep3,
                () => {
                    state.zsMinusErrors++;
                    if (state.zsMinusErrors >= 2) document.getElementById('zsMinusFallback').classList.remove('hidden');
                }
            );
        }

        function showZsMinusStep3() {
            state.zsMinusSubStep = 3;
            const cells = document.querySelectorAll('#zsMinusTenFrame .ten-frame-cell');
            for (let i = 9; i >= 10 - state.zsMinusStillToRemove; i--) {
                setTimeout(() => cells[i].classList.add('removing'), (9-i)*100);
            }
            setTimeout(() => {
                const final = 10 - state.zsMinusStillToRemove;
                document.getElementById('zsMinusQuestion').innerHTML = `10 - ${state.zsMinusStillToRemove} = ?`;
                const options = [final];
                while (options.length < 5) {
                    const opt = final + Math.floor(Math.random()*5)-2;
                    if (opt >= 1 && opt <= 10 && !options.includes(opt)) options.push(opt);
                }
                createAnswerButtons(document.getElementById('zsMinusButtons'), options, final,
                    () => {
                        document.getElementById('zsMinusFinal').textContent = final;
                        document.getElementById('zsMinusResult').classList.add('visible');
                        document.getElementById('zsMinusQuestion').innerHTML = `<strong style="color:var(--success)">${state.zsMinusFirst} - ${state.zsMinusSecond} = ${final}</strong>`;
                        document.getElementById('zsMinusButtons').innerHTML = '';
                        state.correctCount++; state.totalCount++; addStar();
                        setTimeout(nextZsMinusTask, 1500);
                    },
                    () => {
                        state.zsMinusErrors++;
                        if (state.zsMinusErrors >= 2) document.getElementById('zsMinusFallback').classList.remove('hidden');
                    }
                );
            }, state.zsMinusStillToRemove * 100 + 400);
        }

        function nextZsMinusTask() {
            state.currentIndex++;
            selectedEinzelne = 0;
            if (state.currentIndex < state.zsMinusTasks.length) showZsMinusTask();
            else showCompletion();
        }

        // Card Training
        function startCardTraining(type) {
            state.gameType = 'cards';
            state.cards = shuffle([...problemSets[type].problems]);
            state.currentIndex = 0; state.correctCount = 0; state.totalCount = 0;
            showScreen('cardTrainingScreen');
            showCard();
        }

        function showCard() {
            const card = state.cards[state.currentIndex];
            document.getElementById('flashcardContent').textContent = card.q;
            document.getElementById('flashcard').style.background = 'white';
            document.getElementById('flashcard').style.borderColor = '#e9ecef';
            document.getElementById('preRevealControls').classList.remove('hidden');
            document.getElementById('postRevealControls').classList.add('hidden');
            updateProgress('card', state.currentIndex, state.cards.length);
        }

        function revealCardAnswer() {
            const card = state.cards[state.currentIndex];
            document.getElementById('flashcardContent').textContent = card.a;
            document.getElementById('flashcard').style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
            document.getElementById('flashcard').style.borderColor = 'var(--success)';
            document.getElementById('preRevealControls').classList.add('hidden');
            document.getElementById('postRevealControls').classList.remove('hidden');
        }

        function rateCard(correct) {
            state.totalCount++;
            if (correct) { state.correctCount++; addStar(); }
            else { state.cards.push(state.cards[state.currentIndex]); }
            state.currentIndex++;
            if (state.currentIndex < state.cards.length) showCard();
            else showCompletion();
        }

        loadState();
    </script>
</body>
</html>
